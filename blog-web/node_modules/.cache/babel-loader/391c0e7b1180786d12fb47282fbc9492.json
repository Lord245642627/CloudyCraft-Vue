{"ast":null,"code":"/*!\n * vue3-lazy v1.0.0-alpha.1\n * (c) 2020-2020 ustbhuangyi\n * Released under the MIT License.\n */\nvar State;\n\n(function (State) {\n  State[State[\"loading\"] = 0] = \"loading\";\n  State[State[\"loaded\"] = 1] = \"loaded\";\n  State[State[\"error\"] = 2] = \"error\";\n})(State || (State = {}));\n\nvar inBrowser = typeof window !== 'undefined';\nvar hasIntersectionObserver = checkIntersectionObserver();\n\nfunction checkIntersectionObserver() {\n  if (inBrowser && 'IntersectionObserver' in window && 'IntersectionObserverEntry' in window && 'intersectionRatio' in IntersectionObserverEntry.prototype) {\n    // Minimal polyfill for Edge 15's lack of `isIntersecting`\n    // See: https://github.com/w3c/IntersectionObserver/issues/211\n    if (!('isIntersecting' in IntersectionObserverEntry.prototype)) {\n      Object.defineProperty(IntersectionObserverEntry.prototype, 'isIntersecting', {\n        get: function () {\n          return this.intersectionRatio > 0;\n        }\n      });\n    }\n\n    return true;\n  }\n\n  return false;\n}\n\nvar style = function (el, prop) {\n  return getComputedStyle(el).getPropertyValue(prop);\n};\n\nvar overflow = function (el) {\n  return style(el, 'overflow') + style(el, 'overflow-y') + style(el, 'overflow-x');\n};\n\nfunction scrollParent(el) {\n  var parent = el;\n\n  while (parent) {\n    if (parent === document.body || parent === document.documentElement) {\n      break;\n    }\n\n    if (!parent.parentNode) {\n      break;\n    }\n\n    if (/(scroll|auto)/.test(overflow(parent))) {\n      return parent;\n    }\n\n    parent = parent.parentNode;\n  }\n\n  return window;\n}\n\nfunction loadImage(src) {\n  return new Promise(function (resolve, reject) {\n    var image = new Image();\n\n    image.onload = function () {\n      resolve();\n      dispose();\n    };\n\n    image.onerror = function (e) {\n      reject(e);\n      dispose();\n    };\n\n    image.src = src;\n\n    function dispose() {\n      image.onload = image.onerror = null;\n    }\n  });\n}\n\nfunction warn(msg) {\n  console.warn(\"[Vue3-lazy warn]: \" + msg);\n}\n\nvar ImageManager =\n/** @class */\nfunction () {\n  function ImageManager(options) {\n    this.el = options.el;\n    this.parent = options.parent;\n    this.src = options.src;\n    this.error = options.error;\n    this.loading = options.loading;\n    this.cache = options.cache;\n    this.state = State.loading;\n    this.render(this.loading);\n  }\n\n  ImageManager.prototype.load = function (next) {\n    if (this.state > State.loading) {\n      return;\n    }\n\n    if (this.cache.has(this.src)) {\n      this.state = State.loaded;\n      this.render(this.src);\n      return;\n    }\n\n    this.renderSrc(next);\n  };\n\n  ImageManager.prototype.isInView = function () {\n    var rect = this.el.getBoundingClientRect();\n    return rect.top < window.innerHeight && rect.left < window.innerWidth;\n  };\n\n  ImageManager.prototype.update = function (src) {\n    var currentSrc = this.src;\n\n    if (src !== currentSrc) {\n      this.src = src;\n      this.state = State.loading;\n    }\n  };\n\n  ImageManager.prototype.renderSrc = function (next) {\n    var _this = this;\n\n    loadImage(this.src).then(function () {\n      _this.state = State.loaded;\n\n      _this.render(_this.src);\n\n      _this.cache.add(_this.src);\n\n      next && next();\n    }).catch(function (e) {\n      _this.state = State.error;\n\n      _this.render(_this.error);\n\n      warn(\"load failed with src image(\" + _this.src + \") and the error msg is \" + e.message);\n      next && next();\n    });\n  };\n\n  ImageManager.prototype.render = function (src) {\n    this.el.setAttribute('src', src);\n  };\n\n  return ImageManager;\n}();\n\nfunction throttle(fn, delay) {\n  var timeout = 0;\n  var lastRun = 0;\n  return function () {\n    if (timeout) {\n      return;\n    }\n\n    var elapsed = Date.now() - lastRun;\n    var context = this;\n    var args = arguments;\n\n    var runCallback = function () {\n      lastRun = Date.now();\n      timeout = 0;\n      fn.apply(context, args);\n    };\n\n    if (elapsed >= delay) {\n      runCallback();\n    } else {\n      timeout = window.setTimeout(runCallback, delay);\n    }\n  };\n}\n\nvar DEFAULT_URL = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';\nvar events = ['scroll', 'wheel', 'mousewheel', 'resize', 'animationend', 'transitionend', 'touchmove', 'transitioncancel'];\nvar THROTTLE_DELAY = 300;\n\nvar Lazy =\n/** @class */\nfunction () {\n  function Lazy(options) {\n    this.error = options.error || DEFAULT_URL;\n    this.loading = options.loading || DEFAULT_URL;\n    this.cache = new Set();\n    this.managerQueue = [];\n    this.throttleLazyHandler = throttle(this.lazyHandler.bind(this), THROTTLE_DELAY);\n    this.init();\n  }\n\n  Lazy.prototype.add = function (el, binding) {\n    var src = binding.value;\n    var parent = scrollParent(el);\n    var manager = new ImageManager({\n      el: el,\n      parent: parent,\n      src: src,\n      error: this.error,\n      loading: this.loading,\n      cache: this.cache\n    });\n    this.managerQueue.push(manager);\n\n    if (hasIntersectionObserver) {\n      this.observer.observe(el);\n    } else {\n      this.addListenerTarget(parent);\n      this.addListenerTarget(window);\n      this.throttleLazyHandler();\n    }\n  };\n\n  Lazy.prototype.update = function (el, binding) {\n    var src = binding.value;\n    var manager = this.managerQueue.find(function (manager) {\n      return manager.el === el;\n    });\n\n    if (manager) {\n      manager.update(src);\n    }\n  };\n\n  Lazy.prototype.remove = function (el) {\n    var manager = this.managerQueue.find(function (manager) {\n      return manager.el === el;\n    });\n\n    if (manager) {\n      this.removeManager(manager);\n    }\n  };\n\n  Lazy.prototype.init = function () {\n    if (hasIntersectionObserver) {\n      this.initIntersectionObserver();\n    } else {\n      this.targetQueue = [];\n    }\n  };\n\n  Lazy.prototype.initIntersectionObserver = function () {\n    var _this = this;\n\n    this.observer = new IntersectionObserver(function (entries) {\n      entries.forEach(function (entry) {\n        if (entry.isIntersecting) {\n          var manager = _this.managerQueue.find(function (manager) {\n            return manager.el === entry.target;\n          });\n\n          if (manager) {\n            if (manager.state === State.loaded) {\n              _this.removeManager(manager);\n\n              return;\n            }\n\n            manager.load();\n          }\n        }\n      });\n    }, {\n      rootMargin: '0px',\n      threshold: 0\n    });\n  };\n\n  Lazy.prototype.addListenerTarget = function (el) {\n    var target = this.targetQueue.find(function (target) {\n      return target.el === el;\n    });\n\n    if (!target) {\n      target = {\n        el: el,\n        ref: 1\n      };\n      this.targetQueue.push(target);\n      this.addListener(el);\n    } else {\n      target.ref++;\n    }\n  };\n\n  Lazy.prototype.removeListenerTarget = function (el) {\n    var _this = this;\n\n    this.targetQueue.some(function (target, index) {\n      if (el === target.el) {\n        target.ref--;\n\n        if (!target.ref) {\n          _this.removeListener(el);\n\n          _this.targetQueue.splice(index, 1);\n        }\n\n        return true;\n      }\n\n      return false;\n    });\n  };\n\n  Lazy.prototype.addListener = function (el) {\n    var _this = this;\n\n    events.forEach(function (event) {\n      el.addEventListener(event, _this.throttleLazyHandler, {\n        passive: true,\n        capture: false\n      });\n    });\n  };\n\n  Lazy.prototype.removeListener = function (el) {\n    var _this = this;\n\n    events.forEach(function (event) {\n      el.removeEventListener(event, _this.throttleLazyHandler);\n    });\n  };\n\n  Lazy.prototype.lazyHandler = function (e) {\n    for (var i = this.managerQueue.length - 1; i >= 0; i--) {\n      var manager = this.managerQueue[i];\n\n      if (manager.isInView()) {\n        if (manager.state === State.loaded) {\n          this.removeManager(manager);\n          return;\n        }\n\n        manager.load();\n      }\n    }\n  };\n\n  Lazy.prototype.removeManager = function (manager) {\n    var index = this.managerQueue.indexOf(manager);\n\n    if (index > -1) {\n      this.managerQueue.splice(index, 1);\n    }\n\n    if (this.observer) {\n      this.observer.unobserve(manager.el);\n    } else {\n      this.removeListenerTarget(manager.parent);\n      this.removeListenerTarget(window);\n    }\n  };\n\n  return Lazy;\n}();\n\nvar lazyPlugin = {\n  install: function (app, options) {\n    var lazy = new Lazy(options);\n    app.directive('lazy', {\n      mounted: lazy.add.bind(lazy),\n      updated: lazy.update.bind(lazy),\n      unmounted: lazy.update.bind(lazy)\n    });\n  }\n};\nexport default lazyPlugin;","map":{"version":3,"mappings":"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","names":["State","inBrowser","window","hasIntersectionObserver","checkIntersectionObserver","IntersectionObserverEntry","prototype","Object","defineProperty","get","intersectionRatio","style","el","prop","getComputedStyle","getPropertyValue","overflow","scrollParent","parent","document","body","documentElement","parentNode","test","loadImage","src","Promise","resolve","reject","image","Image","onload","dispose","onerror","e","warn","msg","console","options","error","loading","cache","state","render","ImageManager","next","has","loaded","renderSrc","rect","getBoundingClientRect","top","innerHeight","left","innerWidth","currentSrc","then","_this","add","catch","message","setAttribute","throttle","fn","delay","timeout","lastRun","elapsed","Date","now","context","args","arguments","runCallback","apply","setTimeout","DEFAULT_URL","events","THROTTLE_DELAY","Set","managerQueue","throttleLazyHandler","lazyHandler","bind","init","Lazy","binding","value","manager","push","observer","observe","addListenerTarget","find","update","removeManager","initIntersectionObserver","targetQueue","IntersectionObserver","entries","forEach","entry","isIntersecting","target","load","rootMargin","threshold","ref","addListener","some","index","removeListener","splice","event","addEventListener","passive","capture","removeEventListener","i","length","isInView","indexOf","unobserve","removeListenerTarget","lazyPlugin","install","app","lazy","directive","mounted","updated","unmounted"],"sources":["../src/types/index.ts","../src/helpers/dom.ts","../src/helpers/loadImage.ts","../src/helpers/debug.ts","../src/core/imageManager.ts","../src/helpers/util.ts","../src/core/lazy.ts","../src/index.ts"],"sourcesContent":["export enum State {\n  loading,\n  loaded,\n  error\n}\n\nexport interface LazyOptions {\n  error?: string\n  loading?: string\n}\n\nexport interface ImageManagerOptions {\n  el: HTMLElement\n  parent: HTMLElement | Window\n  src: string\n  error: string\n  loading: string\n  cache: Set<string>\n}\n\nexport interface Target {\n  el: HTMLElement | Window\n  ref: number\n}\n\n","const inBrowser = typeof window !== 'undefined'\n\nexport const hasIntersectionObserver = checkIntersectionObserver()\n\nfunction checkIntersectionObserver (): boolean {\n  if (inBrowser &&\n    'IntersectionObserver' in window &&\n    'IntersectionObserverEntry' in window &&\n    'intersectionRatio' in IntersectionObserverEntry.prototype) {\n    // Minimal polyfill for Edge 15's lack of `isIntersecting`\n    // See: https://github.com/w3c/IntersectionObserver/issues/211\n    if (!('isIntersecting' in IntersectionObserverEntry.prototype)) {\n      Object.defineProperty(IntersectionObserverEntry.prototype,\n        'isIntersecting', {\n          get: function (this: IntersectionObserverEntry) {\n            return this.intersectionRatio > 0\n          }\n        })\n    }\n    return true\n  }\n  return false\n}\n\nconst style = (el: HTMLElement, prop: string): string => {\n  return getComputedStyle(el).getPropertyValue(prop)\n}\n\nconst overflow = (el: HTMLElement): string => {\n  return style(el, 'overflow') + style(el, 'overflow-y') + style(el, 'overflow-x')\n}\n\nexport function scrollParent (el: HTMLElement): HTMLElement | Window {\n  let parent = el\n\n  while (parent) {\n    if (parent === document.body || parent === document.documentElement) {\n      break\n    }\n\n    if (!parent.parentNode) {\n      break\n    }\n\n    if (/(scroll|auto)/.test(overflow(parent))) {\n      return parent\n    }\n\n    parent = parent.parentNode as HTMLElement\n  }\n\n  return window\n}\n","export default function loadImage (src: string): Promise<any> {\n  return new Promise((resolve, reject) => {\n    const image = new Image()\n\n    image.onload = function () {\n      resolve()\n      dispose()\n    }\n\n    image.onerror = function (e) {\n      reject(e)\n      dispose()\n    }\n\n    image.src = src\n\n    function dispose () {\n      image.onload = image.onerror = null\n    }\n  })\n}\n","export function warn (msg: string): void {\n  console.warn(`[Vue3-lazy warn]: ${msg}`)\n}\n","import { ImageManagerOptions, State } from '../types'\nimport loadImage from '../helpers/loadImage'\nimport { warn } from '../helpers/debug'\n\nexport default class ImageManager {\n  el: HTMLElement\n  parent: HTMLElement | Window\n  src: string\n  error: string\n  loading: string\n  cache: Set<string>\n  state: State\n\n  constructor (options: ImageManagerOptions) {\n    this.el = options.el\n    this.parent = options.parent\n    this.src = options.src\n    this.error = options.error\n    this.loading = options.loading\n    this.cache = options.cache\n    this.state = State.loading\n\n    this.render(this.loading)\n  }\n\n  load (next?: Function): void {\n    if (this.state > State.loading) {\n      return\n    }\n    if (this.cache.has(this.src)) {\n      this.state = State.loaded\n      this.render(this.src)\n      return\n    }\n    this.renderSrc(next)\n  }\n\n  isInView (): boolean {\n    const rect = this.el.getBoundingClientRect()\n    return rect.top < window.innerHeight && rect.left < window.innerWidth\n  }\n\n  update (src: string): void {\n    const currentSrc = this.src\n    if (src !== currentSrc) {\n      this.src = src\n      this.state = State.loading\n    }\n  }\n\n  private renderSrc (next?: Function): void {\n    loadImage(this.src).then(() => {\n      this.state = State.loaded\n      this.render(this.src)\n      this.cache.add(this.src)\n      next && next()\n    }).catch((e) => {\n      this.state = State.error\n      this.render(this.error)\n      warn(`load failed with src image(${this.src}) and the error msg is ${e.message}`)\n      next && next()\n    })\n  }\n\n  private render (src: string): void {\n    this.el.setAttribute('src', src)\n  }\n}\n","export function throttle (fn: Function, delay: number): Function {\n  let timeout = 0\n  let lastRun = 0\n  return function (this: void) {\n    if (timeout) {\n      return\n    }\n    const elapsed = Date.now() - lastRun\n    const context = this\n    const args = arguments\n    const runCallback = function () {\n      lastRun = Date.now()\n      timeout = 0\n      fn.apply(context, args)\n    }\n    if (elapsed >= delay) {\n      runCallback()\n    } else {\n      timeout = window.setTimeout(runCallback, delay)\n    }\n  }\n}\n","import { DirectiveBinding } from 'vue'\nimport { LazyOptions, State, Target } from '../types'\nimport { hasIntersectionObserver, scrollParent } from '../helpers/dom'\nimport ImageManager from './imageManager'\nimport { throttle } from '../helpers/util'\n\nconst DEFAULT_URL = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'\n\nconst events = ['scroll', 'wheel', 'mousewheel', 'resize', 'animationend', 'transitionend', 'touchmove', 'transitioncancel']\n\nconst THROTTLE_DELAY = 300\n\nexport default class Lazy {\n  error: string\n  loading: string\n  cache: Set<string>\n  managerQueue: ImageManager[]\n  observer?: IntersectionObserver\n  targetQueue?: Target[]\n  throttleLazyHandler: Function\n\n  constructor (options: LazyOptions) {\n    this.error = options.error || DEFAULT_URL\n    this.loading = options.loading || DEFAULT_URL\n\n    this.cache = new Set()\n    this.managerQueue = []\n    this.throttleLazyHandler = throttle(this.lazyHandler.bind(this), THROTTLE_DELAY)\n\n    this.init()\n  }\n\n  add (el: HTMLElement, binding: DirectiveBinding): void {\n    const src = binding.value\n    const parent = scrollParent(el)\n\n    const manager = new ImageManager({\n      el,\n      parent,\n      src,\n      error: this.error,\n      loading: this.loading,\n      cache: this.cache\n    })\n\n    this.managerQueue.push(manager)\n\n    if (hasIntersectionObserver) {\n      this.observer!.observe(el)\n    } else {\n      this.addListenerTarget(parent)\n      this.addListenerTarget(window)\n      this.throttleLazyHandler()\n    }\n  }\n\n  update (el: HTMLElement, binding: DirectiveBinding): void {\n    const src = binding.value\n    const manager = this.managerQueue.find((manager) => {\n      return manager.el === el\n    })\n    if (manager) {\n      manager.update(src)\n    }\n  }\n\n  remove (el: HTMLElement): void {\n    const manager = this.managerQueue.find((manager) => {\n      return manager.el === el\n    })\n    if (manager) {\n      this.removeManager(manager)\n    }\n  }\n\n  private init (): void {\n    if (hasIntersectionObserver) {\n      this.initIntersectionObserver()\n    } else {\n      this.targetQueue = []\n    }\n  }\n\n  private initIntersectionObserver (): void {\n    this.observer = new IntersectionObserver((entries) => {\n      entries.forEach((entry) => {\n        if (entry.isIntersecting) {\n          const manager = this.managerQueue.find((manager) => {\n            return manager.el === entry.target\n          })\n          if (manager) {\n            if (manager.state === State.loaded) {\n              this.removeManager(manager)\n              return\n            }\n            manager.load()\n          }\n        }\n      })\n    }, {\n      rootMargin: '0px',\n      threshold: 0\n    })\n  }\n\n  private addListenerTarget (el: HTMLElement | Window): void {\n    let target = this.targetQueue!.find((target) => {\n      return target.el === el\n    })\n\n    if (!target) {\n      target = {\n        el,\n        ref: 1\n      }\n      this.targetQueue!.push(target)\n      this.addListener(el)\n    } else {\n      target.ref++\n    }\n  }\n\n  private removeListenerTarget (el: HTMLElement | Window): void {\n    this.targetQueue!.some((target, index) => {\n      if (el === target.el) {\n        target.ref--\n        if (!target.ref) {\n          this.removeListener(el)\n          this.targetQueue!.splice(index, 1)\n        }\n        return true\n      }\n      return false\n    })\n  }\n\n  private addListener (el: HTMLElement | Window): void {\n    events.forEach((event) => {\n      el.addEventListener(event, this.throttleLazyHandler as EventListenerOrEventListenerObject, {\n        passive: true,\n        capture: false\n      })\n    })\n  }\n\n  private removeListener (el: HTMLElement | Window): void {\n    events.forEach((event) => {\n      el.removeEventListener(event, this.throttleLazyHandler as EventListenerOrEventListenerObject)\n    })\n  }\n\n  private lazyHandler (e: Event): void {\n    for (let i = this.managerQueue.length - 1; i >= 0; i--) {\n      const manager = this.managerQueue[i]\n      if (manager.isInView()) {\n        if (manager.state === State.loaded) {\n          this.removeManager(manager)\n          return\n        }\n        manager.load()\n      }\n    }\n  }\n\n  private removeManager (manager: ImageManager): void {\n    const index = this.managerQueue.indexOf(manager)\n    if (index > -1) {\n      this.managerQueue.splice(index, 1)\n    }\n    if (this.observer) {\n      this.observer.unobserve(manager.el)\n    } else {\n      this.removeListenerTarget(manager.parent)\n      this.removeListenerTarget(window)\n    }\n  }\n}\n","import { App } from 'vue'\nimport { LazyOptions } from './types'\nimport Lazy from './core/lazy'\n\nconst lazyPlugin = {\n  install (app: App, options: LazyOptions) {\n    const lazy = new Lazy(options)\n\n    app.directive('lazy', {\n      mounted: lazy.add.bind(lazy),\n      updated: lazy.update.bind(lazy),\n      unmounted: lazy.update.bind(lazy)\n    })\n  }\n}\n\nexport default lazyPlugin\n"]},"metadata":{},"sourceType":"module"}